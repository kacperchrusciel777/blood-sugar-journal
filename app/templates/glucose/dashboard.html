{% extends 'base.html' %}

{% block title %}Dashboard - Blood Sugar Journal{% endblock %}

{% block content %}

<h1>Glucose Dashboard</h1>

{% if entries %}
<!-- Filter form -->
<form method="GET" action="{{ url_for('glucose.dashboard') }}" class="filter-form">
    {{ filter_form.hidden_tag() }}

    <div>
        <label for="start_date">Start Date:</label>
        {{ filter_form.start_date(class="date-input") }}
    </div>

    <div>
        <label for="end_date">End Date:</label>
        {{ filter_form.end_date(class="date-input") }}
    </div>

    <div>
        <label for="tag">Measurement Type:</label>
        <select name="tag" id="tag" class="select-input">
            <option value="" {% if not filter_form.tag.data %}selected{% endif %}>All</option>
            <option value="fasting" {% if filter_form.tag.data == 'fasting' %}selected{% endif %}>Fasting</option>
            <option value="post-meal" {% if filter_form.tag.data == 'post-meal' %}selected{% endif %}>Post-meal</option>
            <option value="before sleep" {% if filter_form.tag.data == 'before sleep' %}selected{% endif %}>Before sleep</option>
        </select>
    </div>

    <div class="filter-buttons">
        <button type="submit" class="btn-action">Filter</button>
        <!-- Przycisk reset z data-url -->
        <button type="button" id="resetBtn" data-url="{{ url_for('glucose.dashboard') }}" class="btn-reset">Reset</button>
    </div>
</form>

<!-- Export PDF button -->
<button id="exportPdfBtn" class="btn-action" style="margin-top: 1em;">Export PDF</button>
{% endif %}

<!-- Entries list -->
<ul>
    {% for entry in entries %}
        <li style="margin-bottom: 1.5em;">
            <strong>Glucose: {{ entry.glucose }} mg/dL</strong> â€” 
            <em>{{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}</em>
            {% if entry.tag %}
                <em>({{ entry.tag }})</em>
            {% endif %}
            {% if entry.note %}
                <em>({{ entry.note }})</em>
            {% endif %}
            <div class="actions" style="margin-top: 0.5em;">
                <form method="GET" action="{{ url_for('glucose.edit_entry', id=entry.id) }}" style="display: inline-block;">
                    <button type="submit" class="btn-action">Edit</button>
                </form>
                <form method="POST" action="{{ url_for('glucose.delete_entry', id=entry.id) }}" onsubmit="return confirm('Are you sure you want to delete this entry?');" style="display: inline-block;">
                    {{ delete_form.hidden_tag() }}
                    <button type="submit" class="btn-action btn-delete">Delete</button>
                </form>
            </div>
        </li>
    {% else %}
        <li>No entries yet.</li>
    {% endfor %}
</ul>

{% if glucose_data %}
<div class="chart-container" style="height: 400px; max-width: 800px; margin: auto;">
    <canvas id="glucoseChart" 
        data-labels='{{ glucose_data | map(attribute="date") | list | tojson }}'
        data-values='{{ glucose_data | map(attribute="glucose") | list | tojson }}'>
    </canvas>
</div>

<div id="stats" class="stats-panel" style="max-width: 800px; margin: 2em auto;"
     data-avg-glucose="{{ avg_glucose | round(1) }}"
     data-min-glucose="{{ min_glucose }}"
     data-max-glucose="{{ max_glucose }}">
    <h3>Statistics</h3>
    <div class="stats-grid" style="display: flex; gap: 2em;">
        <div class="stat-box" style="flex: 1; background: #f0f4ff; padding: 1em; border-radius: 6px;">
            <p class="stat-label" style="font-weight: bold;">Average</p>
            <p class="stat-value">{{ avg_glucose | round(1) }} <span class="unit">mg/dL</span></p>
        </div>
        <div class="stat-box" style="flex: 1; background: #f0f4ff; padding: 1em; border-radius: 6px;">
            <p class="stat-label" style="font-weight: bold;">Minimum</p>
            <p class="stat-value">{{ min_glucose }} <span class="unit">mg/dL</span></p>
        </div>
        <div class="stat-box" style="flex: 1; background: #f0f4ff; padding: 1em; border-radius: 6px;">
            <p class="stat-label" style="font-weight: bold;">Maximum</p>
            <p class="stat-value">{{ max_glucose }} <span class="unit">mg/dL</span></p>
        </div>
    </div>
</div>

<!-- Ukryty element do przechowywania entries w JSON -->
<script type="application/json" id="entriesData">
    {{ entries_json | tojson }}
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endif %}

{% endblock %}
